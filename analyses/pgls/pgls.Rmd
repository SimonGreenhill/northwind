---
title: "Phylogenetic Generalised Least Squares Regression"
author: "Simon"
date: "12 April 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ape)
library(nlme)

qqplot <- function(result) {
    res <- resid(result, type="n")
    qqnorm(res)
    qqline(res)
}


dat <- read.delim('../statistics/statistics.dat', header=TRUE)
rownames(dat) <- dat$Label
dat <- dat[c("InventoryLength", "TranscriptLength", "Absences", "Missings", "DistinctMissings")]

tree <- read.nexus('../../data/glottolog/glottolog.trees')

# safety check
if (length(row.names(dat)[row.names(dat) %in% tree$tip.label == FALSE])) {
    stop("Language in data doesn't match tree file")
}

if (length(tree$tip.label[tree$tip.label %in% row.names(dat) == FALSE])) {
    stop("Language in tree doesn't match data file")
}

# ordering
dat <- dat[tree$tip.label, ]

```

## Tree:

Take glottolog tree. Because we don't know the amount of evolution in each language and we need to guess at it for this to work, we can estimate the branch lengths using a Grafen Transform which:

"Grafen's (1989) computation of branch lengths: each node is given a ‘height’, namely the number of leaves of the subtree minus one, 0 for leaves. Each height is scaled so that root height is 1, and then raised at power 'rho' (> 0). Branch lengths are then computed as the difference between height of lower node and height of upper node."

```{r tree}
# Grafen transform to add branchlengths
tree <- compute.brlen(tree, method="Grafen")
plot(tree, cex=0.3)


# construct variance covariance correlation matrix.
mat <- vcv(tree, corr=TRUE)
```


\clearpage 

## Absences is predicted by Number of Phonemes:

Using Pagel's Lambda to rescale branch-lengths (see signal.Rmd). 


```{r}
# DepVar ~ IndVar = (DepVar is predicted by IndVar).
fitAvsPI <- gls(
    Absences ~ InventoryLength,     
    correlation=corPagel(value=0.8, phy=tree, fixed=FALSE), 
    method="ML", data=dat
)

qqplot(fitAvsPI)
plot(fitAvsPI)
```

\clearpage 

### Summary:

```{r}
summary(fitAvsPI)
anova(fitAvsPI)
```




\clearpage 

## Absences is predicted by Length of Transcript:


```{r}
fitAvsTL <- gls(
    Absences ~ TranscriptLength,
    correlation=corPagel(value=0.8, phy=tree, fixed=FALSE),
    method="ML", data=dat
)

qqplot(fitAvsTL)
plot(fitAvsTL)
```

\clearpage 

### Summary

```{r}
summary(fitAvsTL)
anova(fitAvsTL)
```


\clearpage

## Absences is predicted by both Phoneme Inventory Size and Length of Transcript:



```{r}
fitAvsPITL <- gls(
    Absences ~ InventoryLength * TranscriptLength, 
    correlation=corPagel(value=0.8, phy=tree, fixed=FALSE),
    data=dat, method = "ML"
)

qqplot(fitAvsPITL)
plot(fitAvsPITL)
```

\clearpage 

### Summary

```{r}
summary(fitAvsPITL)
anova(fitAvsPITL)
```


\clearpage

## Session info & Citations

```{r session_info, include=TRUE, echo=TRUE, results='markup'}
devtools::session_info()

citation('ape')
citation('nlme')
```
